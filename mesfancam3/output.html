<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FEED</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />

  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;900&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-red: #DA1A32;
      --navy:   #00031F;
      --overlay:#00000022;
      --panel-bg: rgba(0,0,0,0.45);
      --panel-text: #ffffff;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      height: 100%;
      overflow: hidden;
      background: var(--bg-red);
      font-family: "Outfit", sans-serif;
      color: var(--navy);
    }

    .wrapper {
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;

      /* slightly less lift to reduce spacing on huge screens */
      transform: translateY(-2%);
    }

    .manatee-logo {
      width: 80px;
      height: 80px;
      object-fit: contain;
      margin-bottom: 8px;
      border-radius: 12px;
    }

    .title {
      font-size: clamp(22px, 2vw, 28px);      font-weight: 900;
      letter-spacing: 0.5px;
      text-align: center;
      margin-bottom: 12px;
    }

    #displayBox {
      background: var(--overlay);

      /* Scale up as viewport grows, but keep original ratio */
  width: clamp(360px, 30vw, 575px);
  height: calc(clamp(360px, 30vw, 575px) * 4/3);

      border-radius: 8px;
      overflow: hidden;
      position: relative;

      /* Tight margin so layout stays compact */
      margin-bottom: 20px;
    }

    #liveImage {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: none;
    }

    #emptyState {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      padding: 16px;
      color: white;
      font-weight: 700;
      animation: overlayPulse 1.6s ease-in-out infinite;
      font-size: 24px;
    }

    /* Subtle glow and opacity pulse */
    @keyframes overlayPulse {
      0% {
        opacity: 0.5;
        text-shadow: 0 0 4px rgba(255,255,255,0.6);
      }
      50% {
        opacity: 1;
        text-shadow: 0 0 16px rgba(255,255,255,1);
      }
      100% {
        opacity: 0.5;
        text-shadow: 0 0 4px rgba(255,255,255,0.6);
      }
    }

    #qrImage {
      width: clamp(140px, 18vw, 200px);
      height: auto;
      margin: 12px;
      object-fit: contain;
    }

    /* -----------------------------
       ✨ TRIVIA OVERLAYS
    ------------------------------*/

    .overlayBox {
      position: relative;
      width: 100%;
      background: var(--panel-bg);
      color: var(--panel-text);
      border-radius: 8px;
      text-align: center;
      display: none;
      backdrop-filter: blur(4px);
      font-size: clamp(14px, 1.5vw, 22px);
      font-weight: 600;
      padding: clamp(8px, 1vw, 16px);
    }


    #questionOverlay {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      width: 95%;
      z-index: 10;
    }

    
    #bottomOverlayStack {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      width: 95%;
      max-width: clamp(360px, 95%, 600px);

      display: flex;
      flex-direction: column;
      gap: clamp(6px, 1vh, 10px);
      z-index: 10;


      pointer-events: none;
    }

    #liveName {
      font-size: clamp(16px, 2vw, 24px);
      font-weight: 900;
      color: white;
      text-align: center;
      margin-top: -10px;
      display: none; /* still hidden until JS shows it */
      animation: overlayPulse 1.6s ease-in-out infinite;
    }


  </style>
</head>
<body>

<div class="wrapper">

  <img src="assets/mestv.png" class="manatee-logo">

  <div class="title">MANATEE CAM</div>

  <div id="displayBox">

    <!-- LIVE FEED -->
    <img id="liveImage">

    <!-- EMPTY STATE -->
    <div id="emptyState">
      SCAN ME
      <img id="qrImage" src="assets/qr3.png">
      TO CONNECT
    </div>

    <!-- ✨ TRIVIA OVERLAYS -->
    <div id="questionOverlay" class="overlayBox"></div>
    <div id="bottomOverlayStack">
      <div id="classAnswerOverlay" class="overlayBox"></div>
      <div id="correctOverlay" class="overlayBox"></div>
    </div>


      <div id="badConnection" style="
  position:absolute;
  inset:0;
  display:none;
  justify-content:center;
  align-items:center;
  text-align:center;
  background:rgba(0,0,0,0.4);
  color:white;
  font-size:20px;
  font-weight:900;
  backdrop-filter:blur(4px);
">
  BAD CONNECTION<br>
</div>

  </div>

  <div id="liveName">
  </div>

</div>


<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
import { getDatabase, ref, onValue, off } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-database.js";

/* ----------------------------------------
   DOM ELEMENTS
-----------------------------------------*/
const liveName     = document.getElementById("liveName");
const imgEl        = document.getElementById("liveImage");
const emptyState   = document.getElementById("emptyState");
const badOverlay   = document.getElementById("badConnection");

const questionOverlay = document.getElementById("questionOverlay");
const correctOverlay  = document.getElementById("correctOverlay");
const classOverlay    = document.getElementById("classAnswerOverlay");

/* ----------------------------------------
   FIREBASE INIT
-----------------------------------------*/
const firebaseConfig = {
  apiKey: "AIzaSyD36wU7dXJSivL2FMLIt4PyLSy5HtlVQ5A",
  authDomain: "mes-fancam.firebaseapp.com",
  databaseURL: "https://mes-fancam-default-rtdb.firebaseio.com",
  projectId: "mes-fancam",
  storageBucket: "mes-fancam.appspot.com",
  messagingSenderId: "1091345682482",
  appId: "1:1091345682482:web:eb8e8ea08d7a952c022c2b"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ----------------------------------------
   GLOBAL STATE
-----------------------------------------*/
let activeUser = null;
let lastTS = 0;
let lastFrameTime = 0;

let listenersActive = false;
const TIMEOUT_MS = 2000;

/* ----------------------------------------
   REFS
-----------------------------------------*/
const activeUserRef = ref(db, "live/activeUser");

const frameRef = ref(db, "live/frame");
const tsRef    = ref(db, "live/ts");
const userRef  = ref(db, "live/user");

const triviaModeRef = ref(db, "trivia/mode");
const triviaQRef    = ref(db, "trivia/question");
const triviaCRef    = ref(db, "trivia/correct");
const revealRef     = ref(db, "trivia/reveal");

/* ----------------------------------------
   NEW — Load only the live user's name
   (Instead of all participants)
-----------------------------------------*/
function loadLiveUserName(uid) {
  if (!uid) {
    liveName.style.display = "none";
    return;
  }

  const nameRef = ref(db, `participants/${uid}/name`);

  // Download ONCE — extremely tiny cost
  onValue(
    nameRef,
    snap => {
      const name = snap.val();
      if (!name) {
        liveName.style.display = "none";
        return;
      }
      liveName.textContent = name;
      liveName.style.display = "block";
    },
    { onlyOnce: true }
  );
}

/* ----------------------------------------
   LISTENER MANAGER
-----------------------------------------*/
function stopAllListeners() {
  if (!listenersActive) return;

  off(frameRef);
  off(tsRef);
  off(userRef);
  off(triviaModeRef);
  off(triviaQRef);
  off(triviaCRef);
  off(revealRef);

  listenersActive = false;

  questionOverlay.style.display = "none";
  correctOverlay.style.display = "none";
  classOverlay.style.display = "none";
  imgEl.style.display = "none";
  badOverlay.style.display = "none";
}

function startListenersForLiveUser() {
  if (listenersActive || !activeUser) return;
  listenersActive = true;

  /* ----------------------------------------
     FRAME LISTENER
-----------------------------------------*/
  onValue(frameRef, snap => {
    const jpeg = snap.val();
    if (!jpeg) return;

    imgEl.src = jpeg;
    imgEl.style.display = "block";
    emptyState.style.display = "none";
    badOverlay.style.display = "none";

    lastFrameTime = performance.now();
  });

  onValue(tsRef, snap => {
    const ts = snap.val();
    if (!ts || ts <= lastTS) return;
    lastTS = ts;
  });

  // Not technically needed but leaving it is fine
  onValue(userRef, ()=>{});

  /* ----------------------------------------
     TRIVIA LISTENERS
-----------------------------------------*/
  onValue(triviaModeRef, snap => {
    const mode = snap.val() === true;
    if (!mode) {
      questionOverlay.style.display = "none";
      correctOverlay.style.display = "none";
      classOverlay.style.display = "none";
    }
  });

  onValue(triviaQRef, snap => {
    const data = snap.val() || {};
    if (!data.show) {
      questionOverlay.style.display = "none";
      return;
    }
    questionOverlay.textContent = data.text;
    questionOverlay.style.display = "block";
  });

  onValue(triviaCRef, snap => {
    const data = snap.val() || {};
    if (!data.show) {
      correctOverlay.style.display = "none";
      return;
    }
    correctOverlay.textContent = "Answer: " + (data.text || "");
    correctOverlay.style.display = "block";
  });

  onValue(revealRef, snap => {
    const r = snap.val() || {};
    const key = Object.keys(r).find(k => r[k]?.show === true);

    if (!key) {
      classOverlay.style.display = "none";
      return;
    }

    const ansRef = ref(db, `trivia/answers/${key}`);
    onValue(ansRef, aSnap => {
      const d = aSnap.val() || {};
      if (!d.answer) {
        classOverlay.style.display = "none";
        return;
      }
      classOverlay.textContent = "Class Answer: " + d.answer;
      classOverlay.style.display = "block";
    });
  });
}

/* ----------------------------------------
   WATCH ACTIVE USER
-----------------------------------------*/
onValue(activeUserRef, snap => {
  activeUser = snap.val();

  // Load name ONLY for the active user
  loadLiveUserName(activeUser);

  lastTS = 0;
  lastFrameTime = performance.now();

  if (!activeUser) {
    stopAllListeners();
    imgEl.style.display = "none";
    emptyState.style.display = "flex";
    return;
  }

  emptyState.style.display = "none";
  startListenersForLiveUser();
});

/* ----------------------------------------
   BAD CONNECTION CHECK
-----------------------------------------*/
setInterval(() => {
  if (!activeUser) return;

  const delta = performance.now() - lastFrameTime;
  if (delta > TIMEOUT_MS) {
    imgEl.style.display = "none";
    badOverlay.style.display = "flex";
  }
}, 500);

/* ----------------------------------------
   HANDLE OBS SCENE SWITCH
-----------------------------------------*/
document.addEventListener("visibilitychange", () => {
  if (document.hidden) {
    stopAllListeners();
  } else if (activeUser) {
    startListenersForLiveUser();
  }
});
</script>



</body>
</html>
