<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FEED</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />

  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;900&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-red: #DA1A32;
      --navy:   #00031F;
      --overlay:#00000022;
      --panel-bg: rgba(0,0,0,0.45);
      --panel-text: #ffffff;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      height: 100%;
      overflow: hidden;
      background: var(--bg-red);
      font-family: "Outfit", sans-serif;
      color: var(--navy);
    }

    .wrapper {
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      transform: translateY(-5%);
    }

    .manatee-logo {
      width: 80px;
      height: 80px;
      object-fit: contain;
      margin-bottom: 8px;
      border-radius: 12px;
    }

    .title {
      font-size: 22px;
      font-weight: 900;
      letter-spacing: 0.5px;
      text-align: center;
      margin-bottom: 12px;
    }

    #displayBox {
      background: var(--overlay);
      width: calc(100% - 70px);
      max-width: 360px;
      height: calc(360px * 4/3);
      border-radius: 6px;
      overflow: hidden;
      position: relative;
      margin-bottom: 20px;
    }

    #liveImage {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: none;
    }

    #emptyState {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      padding: 16px;
      color: white;
      font-weight: 700;
      animation: overlayPulse 1.6s ease-in-out infinite;
      font-size: 24px;
    }

    /* Subtle glow and opacity pulse */
    @keyframes overlayPulse {
      0% {
        opacity: 0.5;
        text-shadow: 0 0 4px rgba(255,255,255,0.6);
      }
      50% {
        opacity: 1;
        text-shadow: 0 0 16px rgba(255,255,255,1);
      }
      100% {
        opacity: 0.5;
        text-shadow: 0 0 4px rgba(255,255,255,0.6);
      }
    }

    #qrImage {
      width: 200px;
      height: 200px;
      margin: 12px;
      object-fit: contain;
    }

    /* -----------------------------
       ✨ TRIVIA OVERLAYS
    ------------------------------*/

    .overlayBox {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      max-width: 320px;
      background: var(--panel-bg);
      color: var(--panel-text);
      padding: 12px;
      border-radius: 8px;
      text-align: center;
      font-size: 16px;
      font-weight: 900;
      display: none;
      backdrop-filter: blur(4px);
    }

    #questionOverlay {
      top: 10px;
    }

    #correctOverlay {
      bottom: 10px;
    }

    #classAnswerOverlay {
      bottom: 65px;
    }

    #liveName {
      font-size: 20px;
      font-weight: 900;
      color: white;
      text-align: center;
      margin-top: -10px;
      display: none; /* still hidden until JS shows it */
      animation: overlayPulse 1.6s ease-in-out infinite;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to   { opacity: 1; }
    }

  </style>
</head>
<body>

<div class="wrapper">

  <img src="assets/mestv.png" class="manatee-logo">

  <div class="title">MANATEE CAM</div>

  <div id="displayBox">

    <!-- LIVE FEED -->
    <img id="liveImage">

    <!-- EMPTY STATE -->
    <div id="emptyState">
      SCAN ME
      <img id="qrImage" src="assets/qr3.png">
      TO CONNECT
    </div>

    <!-- ✨ TRIVIA OVERLAYS -->
    <div id="questionOverlay" class="overlayBox"></div>
    <div id="correctOverlay" class="overlayBox"></div>
    <div id="classAnswerOverlay" class="overlayBox"></div>

      <div id="badConnection" style="
  position:absolute;
  inset:0;
  display:none;
  justify-content:center;
  align-items:center;
  text-align:center;
  background:rgba(0,0,0,0.4);
  color:white;
  font-size:20px;
  font-weight:900;
  backdrop-filter:blur(4px);
">
  BAD CONNECTION<br>
</div>

  </div>

  <div id="liveName">
  </div>

</div>


<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
import { getDatabase, ref, onValue, off } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-database.js";

/* -------------------------------------------------
   DOM ELEMENTS
--------------------------------------------------*/
const liveName    = document.getElementById("liveName");
const imgEl       = document.getElementById("liveImage");
const emptyState  = document.getElementById("emptyState");
const badOverlay  = document.getElementById("badConnection");

// Prevent initial broken-image flash
imgEl.style.display = "none";
imgEl.src = "";

const questionOverlay = document.getElementById("questionOverlay");
const correctOverlay  = document.getElementById("correctOverlay");
const classOverlay    = document.getElementById("classAnswerOverlay");

/* -------------------------------------------------
   FIREBASE INIT
--------------------------------------------------*/
const firebaseConfig = {
  apiKey: "AIzaSyD36wU7dXJSivL2FMLIt4PyLSy5HtlVQ5A",
  authDomain: "mes-fancam.firebaseapp.com",
  databaseURL: "https://mes-fancam-default-rtdb.firebaseio.com",
  projectId: "mes-fancam",
  storageBucket: "mes-fancam.firebasestorage.app",
  messagingSenderId: "1091345682482",
  appId: "1:1091345682482:web:eb8e8ea08d7a952c022c2b"
};

const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

/* -------------------------------------------------
   GLOBAL STATE
--------------------------------------------------*/
let participantsCache = {};
let activeUser = null;

let lastTS = 0;           // last timestamp from DB
let lastFrameTime = 0;    // when we last displayed a frame
const TIMEOUT_MS = 2000;  // frame timeout

/* -------------------------------------------------
   UTILS
--------------------------------------------------*/
function updateLiveName() {
  if (!activeUser || !participantsCache[activeUser]) {
    liveName.style.display = "none";
    return;
  }

  liveName.textContent = participantsCache[activeUser].name || "";
  liveName.style.display = "block";
}

/* -------------------------------------------------
   WHO IS LIVE?
--------------------------------------------------*/
const activeUserRef  = ref(db, "live/activeUser");
const participantsRef = ref(db, "participants");

onValue(activeUserRef, snap => {
  activeUser = snap.val();

  updateLiveName();

  // fresh start
  lastFrameTime = performance.now();
  lastTS        = 0;

  // hide overlays immediately
  badOverlay.style.display = "none";
});

onValue(participantsRef, snap => {
  participantsCache = snap.val() || {};
  updateLiveName();
});

/* -------------------------------------------------
   LIVE FRAME STREAM
   atomic + filtered + drop stale
--------------------------------------------------*/
const liveRef = ref(db, "live");

onValue(liveRef, snap => {
  const data = snap.val();

  // nothing in DB yet?
  if (!data) {
    imgEl.style.display = "none";
    emptyState.style.display = "flex";
    badOverlay.style.display = "none";
    return;
  }

  const { frame, ts, user } = data;

  // Ignore non-active frames
  if (!activeUser || user !== activeUser) return;

  // Kicked or camera disabled → instantly switch to next user
  if (!participantsCache[activeUser] || participantsCache[activeUser].cameraActive !== true) {

    // hide
    imgEl.style.display = "none";
    emptyState.style.display = "flex";

    // auto-switch to the next person
    const keys = Object.keys(participantsCache);
    const next = keys.find(k => participantsCache[k].cameraActive === true);

    if (next) {
      // assign new live user
      update(ref(db, "live"), { activeUser: next });
    }

    return;
  }

  // drop stale
  if (!ts || ts <= lastTS) return;

  // accept
  lastTS = ts;
  lastFrameTime = performance.now();

  imgEl.src = frame;
  imgEl.onload = () => {
  imgEl.style.display = "block";
  emptyState.style.display = "none";
  };
  imgEl.onerror = () => {
    imgEl.style.display = "none";
  };

  imgEl.style.display = "block";
  emptyState.style.display = "none";
  badOverlay.style.display = "none";
});

/* -------------------------------------------------
   BAD CONNECTION MONITOR
--------------------------------------------------*/
setInterval(() => {

  // no live user → QR state
  if (!activeUser) {
    imgEl.style.display = "none";
    emptyState.style.display = "flex";
    badOverlay.style.display = "none";
    return;
  }

  const delta = performance.now() - lastFrameTime;

  // no frames recently → bad connection
  if (delta > TIMEOUT_MS) {
    imgEl.style.display = "none";
    emptyState.style.display = "none";
    badOverlay.style.display = "flex";
  }

}, 500);

/* -------------------------------------------------
   TRIVIA MODE
   (unchanged from yours, simplified)
--------------------------------------------------*/
const triviaModeRef  = ref(db, "trivia/mode");
const triviaQRef     = ref(db, "trivia/question");
const triviaCRef     = ref(db, "trivia/correct");
const revealRef      = ref(db, "trivia/reveal");

let triviaMode = false;
let lastAnswerListenerRef = null;

/* trivia mode ON/OFF */
onValue(triviaModeRef, snap => {
  triviaMode = snap.val() === true;

  if (!triviaMode) {
    questionOverlay.style.display = "none";
    correctOverlay.style.display = "none";
    classOverlay.style.display = "none";

    if (lastAnswerListenerRef) {
      off(lastAnswerListenerRef);
      lastAnswerListenerRef = null;
    }
  }
});

/* global question overlay */
onValue(triviaQRef, snap => {
  const data = snap.val() || {};

  if (!triviaMode || !data.show) {
    questionOverlay.style.display = "none";
    return;
  }

  questionOverlay.textContent = data.text || "";
  questionOverlay.style.display = "block";
});

/* correct answer overlay */
onValue(triviaCRef, snap => {
  const data = snap.val() || {};

  if (!triviaMode || !data.show) {
    correctOverlay.style.display = "none";
    return;
  }

  correctOverlay.textContent = "Correct Answer: " + (data.text || "");
  correctOverlay.style.display = "block";
});

/* class answer overlay */
onValue(revealRef, snap => {

  if (!triviaMode || !snap.exists()) {
    classOverlay.style.display = "none";

    if (lastAnswerListenerRef) {
      off(lastAnswerListenerRef);
      lastAnswerListenerRef = null;
    }

    return;
  }

  const revealData = snap.val();
  const keys = Object.keys(revealData);

  const revealedKey = keys.find(k =>
    revealData[k] &&
    typeof revealData[k] === "object" &&
    revealData[k].show === true
  );

  if (!revealedKey) {
    classOverlay.style.display = "none";

    if (lastAnswerListenerRef) {
      off(lastAnswerListenerRef);
      lastAnswerListenerRef = null;
    }

    return;
  }

  // cancel previous
  if (lastAnswerListenerRef) {
    off(lastAnswerListenerRef);
  }

  const answerPath = ref(db, `trivia/answers/${revealedKey}`);
  lastAnswerListenerRef = answerPath;

  onValue(answerPath, answerSnap => {
    const answerData = answerSnap.val() || {};

    if (!answerData.answer) {
      classOverlay.style.display = "none";
      return;
    }

    classOverlay.textContent = "Their Answer: " + answerData.answer;
    classOverlay.style.display = "block";
  });
});

/* ----------------------------------------
   END SESSION → SHOW THANK YOU OVERLAY
---------------------------------------- */
onValue(ref(db, "participants"), snap => {
  if (snap.exists()) return; // only when fully cleared

  imgEl.style.display = "none";
  emptyState.style.display = "none";

document.body.innerHTML = `
  <div style="
    height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    text-align:center;
    font-size:22px;
    font-weight:900;
    color:white;
    padding:20px;
    animation: fadeIn 0.4s ease;">
    THANKS FOR JOINING!
  </div>
`;

setTimeout(() => {
  // fade out to QR
  document.body.style.opacity = 0;
  setTimeout(() => {
    window.location.href = "output.html"; // reload into fresh QR
  }, 600);
}, 4000);
});

</script>


</body>
</html>
